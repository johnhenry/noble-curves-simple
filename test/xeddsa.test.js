import { randomBytes } from '@noble/hashes/utils';
import { describe, should } from 'micro-should';
import { deepStrictEqual } from 'node:assert';
import { ed25519, x25519, xeddsa25519, edwardsToMontgomeryPriv } from '../esm/ed25519.js';

describe('xeddsa25519', () => {
  should('signatures', () => {
    const alicePrivate = new Uint8Array([
      0xc0, 0x97, 0x24, 0x84, 0x12, 0xe5, 0x8b, 0xf0, 0x5d, 0xf4, 0x87, 0x96, 0x82, 0x05, 0x13,
      0x27, 0x94, 0x17, 0x8e, 0x36, 0x76, 0x37, 0xf5, 0x81, 0x8f, 0x81, 0xe0, 0xe6, 0xce, 0x73,
      0xe8, 0x65,
    ]);
    const alicePublic = new Uint8Array([
      0xab, 0x7e, 0x71, 0x7d, 0x4a, 0x16, 0x3b, 0x7d, 0x9a, 0x1d, 0x80, 0x71, 0xdf, 0xe9, 0xdc,
      0xf8, 0xcd, 0xcd, 0x1c, 0xea, 0x33, 0x39, 0xb6, 0x35, 0x6b, 0xe8, 0x4d, 0x88, 0x7e, 0x32,
      0x2c, 0x64,
    ]);
    const message = new Uint8Array([
      0x05, 0xed, 0xce, 0x9d, 0x9c, 0x41, 0x5c, 0xa7, 0x8c, 0xb7, 0x25, 0x2e, 0x72, 0xc2, 0xc4,
      0xa5, 0x54, 0xd3, 0xeb, 0x29, 0x48, 0x5a, 0x0e, 0x1d, 0x50, 0x31, 0x18, 0xd1, 0xa8, 0x2d,
      0x99, 0xfb, 0x4a,
    ]);
    const aliceSignature = new Uint8Array([
      0x5d, 0xe8, 0x8c, 0xa9, 0xa8, 0x9b, 0x4a, 0x11, 0x5d, 0xa7, 0x91, 0x09, 0xc6, 0x7c, 0x9c,
      0x74, 0x64, 0xa3, 0xe4, 0x18, 0x02, 0x74, 0xf1, 0xcb, 0x8c, 0x63, 0xc2, 0x98, 0x4e, 0x28,
      0x6d, 0xfb, 0xed, 0xe8, 0x2d, 0xeb, 0x9d, 0xcd, 0x9f, 0xae, 0x0b, 0xfb, 0xb8, 0x21, 0x56,
      0x9b, 0x3d, 0x90, 0x01, 0xbd, 0x81, 0x30, 0xcd, 0x11, 0xd4, 0x86, 0xce, 0xf0, 0x47, 0xbd,
      0x60, 0xb8, 0x6e, 0x88,
    ]);
    deepStrictEqual(x25519.getPublicKey(alicePrivate), alicePublic);
    deepStrictEqual(xeddsa25519.verify(alicePublic, message, aliceSignature), true);
    for (let i = 0; i < aliceSignature.length; i++) {
      const copy = aliceSignature.slice();
      copy[i] ^= 0x01;
      deepStrictEqual(xeddsa25519.verify(alicePublic, message, copy), false);
    }
    const zeroSignature = new Uint8Array([
      220, 159, 25, 158, 17, 225, 126, 58, 4, 47, 234, 191, 66, 75, 186, 23, 69, 151, 134, 166, 105,
      48, 110, 213, 45, 62, 140, 235, 200, 11, 98, 70, 114, 170, 216, 146, 18, 198, 125, 71, 136,
      129, 223, 253, 240, 235, 84, 59, 153, 38, 93, 215, 204, 89, 95, 175, 102, 11, 229, 210, 124,
      90, 72, 135,
    ]);
    deepStrictEqual(xeddsa25519.sign(alicePrivate, message, new Uint8Array(64)), zeroSignature);
    deepStrictEqual(xeddsa25519.verify(alicePublic, message, zeroSignature), true);
  });
  should('random signatures', () => {
    for (let i = 0; i < 50; i++) {
      const msg = randomBytes(64);
      // x25519 can generate invalid U
      const secret = edwardsToMontgomeryPriv(ed25519.utils.randomPrivateKey());
      const pub = x25519.getPublicKey(secret);
      const signature = xeddsa25519.sign(secret, msg);
      deepStrictEqual(xeddsa25519.verify(pub, msg, signature), true);
    }
  });
});

should.runWhen(import.meta.url);
